<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TablesMathAssist - DSR</title>
  <!-- Chart.js pour statistiques avanc√©es -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --gradient-day: linear-gradient(180deg, #ffffff 0%, #e3f2fd 100%);
      --gradient-night: linear-gradient(180deg, #000000 0%, #0d47a1 100%);
      --text-day: #1a1a1a;
      --text-night: #ffffff;
      --accent-day: #1976d2;
      --accent-night: #00bcd4;
      --card-day: rgba(0, 0, 0, 0.05);
      --card-night: rgba(255, 255, 255, 0.1);
      
      /* VARIABLES PROFILS ADAPTATIFS */
      --primary-color: #4ECDC4;
      --secondary-color: #45B7D1;
      --accent-color: #FECA57;
      --font-size: 16px;
      --border-radius: 15px;
      --shadow-intensity: 0.3;
    }
    
    /* ========== PROFILS COULEURS DYNAMIQUES AVANC√âS ========== */
    body[data-profile="CM1"] {
      --primary-color: #FF6B35;
      --secondary-color: #FFD23F;
      --accent-color: #06D6A0;
      --font-size: 18px;
      --border-radius: 25px;
      --shadow-intensity: 0.4;
    }
    
    body[data-profile="CM2"] {
      --primary-color: #4ECDC4;
      --secondary-color: #45B7D1;
      --accent-color: #FECA57;
      --font-size: 16px;
      --border-radius: 20px;
      --shadow-intensity: 0.35;
    }
    
    body[data-profile="6EME"] {
      --primary-color: #6C5CE7;
      --secondary-color: #74B9FF;
      --accent-color: #00B894;
      --font-size: 15px;
      --border-radius: 15px;
      --shadow-intensity: 0.25;
    }
    
    body[data-profile="5EME"] {
      --primary-color: #2D3436;
      --secondary-color: #636E72;
      --accent-color: #00CEC9;
      --font-size: 14px;
      --border-radius: 10px;
      --shadow-intensity: 0.15;
      --gradient-night: linear-gradient(180deg, #2d3436 0%, #636e72 100%);
      --gradient-day: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    body[data-profile="ADULTE"] {
      --primary-color: #2F3640;
      --secondary-color: #57606F;
      --accent-color: #3742FA;
      --font-size: 13px;
      --border-radius: 8px;
      --shadow-intensity: 0.1;
      --gradient-night: linear-gradient(180deg, #2f3640 0%, #57606f 100%);
      --gradient-day: linear-gradient(180deg, #ffffff 0%, #f1f2f6 100%);
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      background: var(--gradient-night);
      color: var(--text-night);
      font-family: "Segoe UI", Arial, Helvetica, sans-serif;
      min-height: 100vh;
      transition: all .3s;
      font-size: var(--font-size);
    }
    
    body.day-mode {
      background: var(--gradient-day);
      color: var(--text-day);
    }
    
    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    
    /* ========== ALIGNEMENT PARFAIT HEADER/CARDS ========== */
    .header, .card {
      width: 100%;
      max-width: 800px;
      background: var(--card-night);
      border-radius: var(--border-radius);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,var(--shadow-intensity));
      margin: 15px auto;
    }
    
    body.day-mode .header, body.day-mode .card { 
      background: var(--card-day);
    }
    
    /* ========== HEADER DESKTOP ========== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .header-top {
      display: none;
    }
    
    .header-logo img {
      height: 60px;
      width: auto;
    }
    
    .app-title {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
      flex: 1;
      transition: all 0.3s ease;
    }
    
    /* ANIMATIONS TITRE PAR PROFIL */
    body[data-profile="CM1"] .app-title:hover {
      animation: titleBounce 0.6s ease-in-out;
    }
    
    body[data-profile="CM2"] .app-title:hover {
      animation: titlePulse 0.8s ease-in-out;
    }
    
    body[data-profile="6EME"] .app-title:hover {
      animation: titleGlow 1s ease-in-out;
    }
    
    @keyframes titleBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes titlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes titleGlow {
      0%, 100% { text-shadow: 0 0 10px var(--primary-color); }
      50% { text-shadow: 0 0 20px var(--primary-color), 0 0 30px var(--primary-color); }
    }
    
    .btn-theme, .btn-settings {
      background: none;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      width: 50px; 
      height: 50px;
      cursor: pointer;
      font-size: 1.5rem;
      transition: all .3s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
    }
    
    .btn-theme:hover, .btn-settings:hover { 
      transform: scale(1.1); 
      background: var(--primary-color);
    }
    
    .btn-settings .gear-icon {
      transition: transform 0.5s ease;
    }
    .btn-settings:hover .gear-icon {
      transform: rotate(180deg);
    }

    /* ========== MODAL PARAM√àTRES ========== */
    .settings-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .settings-modal-overlay.active {
      display: flex;
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .settings-modal-content {
      background: #ffffff;
      color: #333;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: var(--border-radius);
      padding: 25px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .settings-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    
    .settings-modal-header h2 {
      margin: 0;
      font-size: 1.6rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .settings-modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #999;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .settings-modal-close:hover {
      color: #f44336;
      transform: scale(1.2) rotate(90deg);
      background: rgba(244, 67, 54, 0.1);
    }
    
    .settings-section {
      margin-bottom: 25px;
    }
    
    .settings-section h3 {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--primary-color);
      border-left: 4px solid var(--primary-color);
      padding-left: 12px;
    }
    
    .profile-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .profile-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fafafa;
      position: relative;
      overflow: hidden;
    }
    
    .profile-option:hover {
      background: #f0f0f0;
      border-color: #c0c0c0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .profile-option:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .profile-option:hover:before {
      left: 100%;
    }
    
    .profile-option input[type="radio"] {
      margin-top: 2px;
      transform: scale(1.2);
      accent-color: var(--primary-color);
    }
    
    .profile-option input[type="radio"]:checked + .profile-info {
      animation: profileSelected 0.5s ease-out;
    }
    
    @keyframes profileSelected {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    .profile-option input[type="radio"]:checked + .profile-info .profile-label {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .profile-info {
      flex: 1;
    }
    
    .profile-label {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 4px;
      transition: all 0.3s ease;
    }
    
    .profile-description {
      font-size: 0.9rem;
      color: #666;
      line-height: 1.3;
    }
    
    .cm1-color { color: #FF6B35; }
    .cm2-color { color: #4ECDC4; }
    .sixieme-color { color: #6C5CE7; }
    .cinquieme-color { color: #2D3436; }
    .adulte-color { color: #2F3640; }
    
    .toggle-option {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      margin-top: 12px;
      padding: 10px;
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
    }
    
    .toggle-option:hover {
      background: #f5f5f5;
      transform: translateX(5px);
    }
    
    .toggle-slider {
      width: 50px;
      height: 26px;
      border-radius: 13px;
      background: #ccc;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .toggle-slider::before {
      content: '';
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: white;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    input[type="checkbox"]:checked + .toggle-slider {
      background: #4CAF50;
    }
    
    input[type="checkbox"]:checked + .toggle-slider::before {
      transform: translateX(24px) scale(1.1);
    }
    
    input[type="checkbox"] {
      display: none;
    }
    
    .settings-modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .btn-save, .btn-cancel {
      border: none;
      border-radius: var(--border-radius);
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn-save {
      background: #4CAF50;
      color: white;
    }
    
    .btn-save:hover {
      background: #43a047;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    
    .btn-cancel {
      background: #f44336;
      color: white;
    }
    
    .btn-cancel:hover {
      background: #e53935;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
    }
    
    /* ========== STATISTIQUES AVANC√âES ADULTE/ENSEIGNANT ========== */
    .stats-dashboard {
      display: none;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    body[data-profile="ADULTE"] .stats-dashboard {
      display: grid;
    }
    
    .stats-card {
      background: var(--card-night);
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      padding: 20px;
      transition: all 0.3s ease;
    }
    
    body.day-mode .stats-card {
      background: var(--card-day);
    }
    
    .stats-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .stats-card h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chart-container {
      position: relative;
      height: 200px;
    }
    
    .export-buttons {
      display: none;
      gap: 10px;
      margin-top: 20px;
    }
    
    body[data-profile="ADULTE"] .export-buttons {
      display: flex;
    }
    
    .btn-export {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .btn-export:hover {
      background: var(--secondary-color);
      transform: translateY(-1px);
    }
    
    /* ========== MOBILE RESPONSIVE ========== */
    @media (max-width: 768px) {
      .app-container {
        padding: 15px;
      }
      
      .header, .card {
        width: calc(100vw - 30px);
        max-width: calc(100vw - 30px);
        margin-left: auto;
        margin-right: auto;
        margin-top: 15px;
        margin-bottom: 15px;
      }
      
      .header {
        flex-direction: column;
        align-items: center;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .header-top {
        display: flex;
        width: 100%;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      
      .header-logo img {
        height: 50px;
      }
      
      .app-title {
        font-size: 1.8rem;
        margin: 0;
      }
      
      .btn-theme, .btn-settings {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
        margin-left: 8px;
      }
      
      .card {
        padding: 20px;
      }
      
      .settings-modal-content {
        width: 95%;
        max-height: 90vh;
        padding: 20px;
      }
      
      .profile-option {
        padding: 12px;
      }
      
      .settings-modal-footer {
        flex-direction: column;
      }
      
      .btn-save, .btn-cancel {
        width: 100%;
        padding: 14px;
      }
      
      .stats-dashboard {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .app-container {
        padding: 12px;
      }
      
      .header, .card {
        width: calc(100vw - 24px);
        max-width: calc(100vw - 24px);
        padding: 18px;
      }
      
      .app-title {
        font-size: 1.5rem;
      }
    }
    
    .card {
      padding: 30px;
    }
    
    .welcome-message {
      text-align: center; 
      font-size: 1.3rem; 
      line-height: 1.6;
      font-weight: 500;
    }
    
    .settings-panel h2, .learn-panel h2 {
      color: var(--primary-color); 
      margin-bottom: 25px;
      font-size: 2rem; 
      text-align: center;
    }
    
    .learn-panel {
      text-align: center;
    }
    
    .learn-panel .welcome-section {
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(142, 36, 170, 0.1);
      border-radius: var(--border-radius);
      border: 1px solid rgba(142, 36, 170, 0.3);
    }
    
    body.day-mode .learn-panel .welcome-section {
      background: rgba(142, 36, 170, 0.05);
    }
    
    .settings-motivating-message {
      text-align: center; 
      font-size: 1.2rem; 
      line-height: 1.5;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(25, 118, 210, 0.1);
      border-radius: var(--border-radius);
      border: 1px solid rgba(25, 118, 210, 0.2);
    }
    
    body.day-mode .settings-motivating-message {
      background: rgba(25, 118, 210, 0.08);
    }
    
    .form-group { margin-bottom: 25px;}
    
    .form-label {
      display: block; 
      font-size: 1.2rem; 
      font-weight: bold; 
      margin-bottom: 10px; 
      color: var(--primary-color);
    }
    
    .tables-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px; 
      margin-top: 10px;
    }
    
    .tables-selector label {
      display: flex; 
      align-items: center; 
      font-size: 1.1rem; 
      cursor: pointer; 
      padding: 8px; 
      border-radius: var(--border-radius);
      transition: all .3s;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }
    
    .tables-selector label:hover {
      background: rgba(78, 205, 196, 0.1);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .tables-selector input[type="checkbox"] {
      margin-right: 8px; 
      transform: scale(1.2);
      accent-color: var(--primary-color);
    }
    
    .tables-selector input[type="checkbox"]:checked + span {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    /* ANIMATIONS CHECKBOX PAR PROFIL */
    body[data-profile="CM1"] .tables-selector input[type="checkbox"]:checked + span {
      animation: checkboxBounce 0.4s ease-out;
    }
    
    body[data-profile="CM2"] .tables-selector input[type="checkbox"]:checked + span {
      animation: checkboxPulse 0.5s ease-out;
    }
    
    body[data-profile="6EME"] .tables-selector input[type="checkbox"]:checked + span {
      animation: checkboxGlow 0.6s ease-out;
    }
    
    @keyframes checkboxBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    @keyframes checkboxPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes checkboxGlow {
      0%, 100% { text-shadow: none; }
      50% { text-shadow: 0 0 8px var(--primary-color); }
    }
    
    select {
      width: 100%; 
      padding: 12px;
      font-size: 1.1rem;
      border: 2px solid var(--primary-color);
      border-radius: var(--border-radius);
      background: var(--card-night);
      color: var(--text-night);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    select:hover {
      border-color: var(--secondary-color);
      transform: translateY(-1px);
    }
    
    body.day-mode select {
      border-color: var(--primary-color);
      background: var(--card-day);
      color: var(--text-day);
    }
    
    .btn-primary {
      background: var(--primary-color); 
      color: white;
      border: none; 
      padding: 15px 30px; 
      font-size: 1.3rem; 
      font-weight: bold;
      border-radius: var(--border-radius);
      cursor: pointer; 
      transition: all .3s;
      margin: 10px;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-primary:hover:before {
      left: 100%;
    }
    
    .btn-primary:hover { 
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    /* ANIMATIONS BOUTONS PAR PROFIL */
    body[data-profile="CM1"] .btn-primary:hover {
      animation: buttonBounce 0.6s ease-in-out;
    }
    
    body[data-profile="CM2"] .btn-primary:hover {
      animation: buttonRipple 0.8s ease-out;
    }
    
    @keyframes buttonBounce {
      0%, 100% { transform: translateY(-3px); }
      50% { transform: translateY(-8px) scale(1.05); }
    }
    
    @keyframes buttonRipple {
      0% { box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
      50% { box-shadow: 0 6px 20px rgba(0,0,0,0.3), 0 0 0 10px rgba(78, 205, 196, 0.2); }
      100% { box-shadow: 0 6px 20px rgba(0,0,0,0.3), 0 0 0 20px transparent; }
    }
    
    /* ========== PAGES APPRENTISSAGE ========== */
    #learnPage, #tableDetailPage { display: none; }
    
    .learn-title, .table-detail-title {
      font-size: 2rem; 
      font-weight: bold; 
      margin-bottom: 5px; 
      text-align: center;
      color: var(--text-night);
    }
    
    body.day-mode .learn-title, body.day-mode .table-detail-title { 
      color: var(--text-day); 
    }
    
    .learn-sub, .table-detail-sub {
      font-size: 1.1rem; 
      text-align: center; 
      margin-bottom: 25px;
      color: var(--text-night);
    }
    
    body.day-mode .learn-sub, body.day-mode .table-detail-sub { 
      color: var(--text-day); 
    }
    
    .legend {
      display: flex; 
      justify-content: center; 
      gap: 20px; 
      margin-bottom: 25px; 
      font-weight: 600; 
      color: var(--text-night);
    }
    
    body.day-mode .legend { color: var(--text-day); }
    .legend span { display: flex; align-items: center; gap: 6px; }
    .legend i { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
    
    .grid-tables {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 18px;
    }
    
    .table-card {
      background: rgba(255, 255, 255, 0.9);
      border: 3px solid;
      border-radius: var(--border-radius);
      padding: 25px 10px;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      transition: all .3s;
      color: #333;
      position: relative;
      overflow: hidden;
    }
    
    body.day-mode .table-card {
      background: rgba(255, 255, 255, 0.95);
    }
    
    .table-card:hover { 
      transform: translateY(-6px); 
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    .table-card.hidden { display: none; }
    .table-num { font-size: 2rem; margin-bottom: 8px; }
    .diff-label { font-size: 0.9rem; font-weight: 600; }
    .easy { border-color: #4caf50; }
    .medium { border-color: #ff9800; }
    .hard { border-color: #f44336; }
    
    /* ANIMATIONS TABLE-CARDS PAR PROFIL */
    body[data-profile="CM1"] .table-card:hover {
      animation: cardBounce 0.5s ease-in-out;
    }
    
    body[data-profile="CM2"] .table-card:hover {
      animation: cardScale 0.4s ease-out;
    }
    
    body[data-profile="6EME"] .table-card:hover {
      animation: cardGlow 0.6s ease-in-out;
    }
    
    @keyframes cardBounce {
      0%, 100% { transform: translateY(-6px); }
      50% { transform: translateY(-12px); }
    }
    
    @keyframes cardScale {
      0%, 100% { transform: translateY(-6px) scale(1); }
      50% { transform: translateY(-6px) scale(1.05); }
    }
    
    @keyframes cardGlow {
      0%, 100% { 
        transform: translateY(-6px); 
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      }
      50% { 
        transform: translateY(-6px); 
        box-shadow: 0 8px 25px rgba(0,0,0,0.2), 0 0 20px var(--primary-color);
      }
    }
    
    /* Page d√©tail table */
    .table-detail-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin-bottom: 25px;
    }
    
    .btn-astuce {
      background: #4285f4; 
      color: white;
      border: none; 
      padding: 10px 20px; 
      font-size: 1.1rem; 
      font-weight: bold;
      border-radius: var(--border-radius); 
      cursor: pointer; 
      transition: all .3s;
      display: flex; 
      align-items: center; 
      gap: 8px;
    }
    
    .btn-astuce:hover { background: #3367d6; }
    
    .btn-return {
      background: #6c757d; 
      color: white;
      border: none; 
      padding: 10px 20px; 
      font-size: 1.1rem; 
      font-weight: bold;
      border-radius: var(--border-radius); 
      cursor: pointer; 
      transition: all .3s;
    }
    
    .btn-return:hover { background: #5a6268; }
    
    .multiplication-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }
    
    .mult-card {
      background: var(--primary-color);
      color: white;
      border-radius: var(--border-radius);
      padding: 20px 10px;
      text-align: center;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }
    
    .mult-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .mult-question {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    
    .mult-answer {
      font-size: 1.8rem;
      color: #ffd700;
    }
    
    /* ========== MODAL ASTUCES ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active { 
      display: flex; 
      animation: modalFadeIn 0.3s ease-out;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background: #000000;
      opacity: 1.0;
      border: 3px solid var(--primary-color);
      border-radius: var(--border-radius);
      padding: 30px;
      max-width: 90vw;
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 255, 255, 0.4);
      animation: modalSlideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes modalSlideUp {
      from { transform: translateY(50px) scale(0.9); }
      to { transform: translateY(0) scale(1); }
    }
    
    body.day-mode .modal-content { 
      background: #f5f5f5;
      color: #333;
      opacity: 1.0;
      border: 3px solid var(--primary-color);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    }
    
    .modal-close {
      position: absolute;
      top: 12px; right: 18px;
      background: none; border: none;
      font-size: 2rem; cursor: pointer;
      color: var(--primary-color);
      font-weight: bold;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .modal-close:hover {
      color: #ff4444;
      transform: scale(1.3) rotate(90deg);
      background: rgba(255, 68, 68, 0.1);
    }
    
    .modal-title {
      font-size: 1.6rem; 
      font-weight: bold;
      margin-bottom: 20px; 
      text-align: center;
      color: var(--primary-color);
      padding-right: 40px;
    }
    
    .astuce-list {
      list-style: none; 
      padding: 0; 
      margin: 0;
    }
    
    .astuce-list li {
      margin-bottom: 15px; 
      padding: 12px 15px;
      font-size: 1.1rem; 
      line-height: 1.5;
      color: #ffffff;
      background: rgba(0, 188, 212, 0.1);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
      animation: astuceSlideIn 0.5s ease-out backwards;
    }
    
    .astuce-list li:nth-child(1) { animation-delay: 0.1s; }
    .astuce-list li:nth-child(2) { animation-delay: 0.2s; }
    .astuce-list li:nth-child(3) { animation-delay: 0.3s; }
    .astuce-list li:nth-child(4) { animation-delay: 0.4s; }
    .astuce-list li:nth-child(5) { animation-delay: 0.5s; }
    
    @keyframes astuceSlideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .astuce-list li:hover {
      transform: translateX(5px);
      background: rgba(0, 188, 212, 0.15);
    }
    
    body.day-mode .astuce-list li { 
      color: #333333;
      background: rgba(25, 118, 210, 0.1);
      border-left: 4px solid var(--primary-color);
    }
    
    body.day-mode .astuce-list li:hover {
      background: rgba(25, 118, 210, 0.15);
    }
    
    .game-area, .results-area { 
      display:none; 
      text-align:center;
    }
    
    /* ========== PISTE DE COURSE LUDIQUE AVEC ANIMATIONS PROFILS ========== */
    .race-track {
      width: 100%;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-night);
      border-radius: var(--border-radius);
      border: 2px solid var(--primary-color);
      position: relative;
      overflow: hidden;
    }
    
    .race-track:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: trackShimmer 3s infinite;
    }
    
    @keyframes trackShimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    body.day-mode .race-track {
      background: var(--card-day);
      border-color: var(--primary-color);
    }
    
    .race-track-title {
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    
    .track-container {
      position: relative;
      width: 100%;
      height: 50px;
      background: linear-gradient(90deg, #4CAF50 0%, #FFC107 50%, #F44336 100%);
      border-radius: 25px;
      border: 3px solid #333;
      overflow: hidden;
    }
    
    body.day-mode .track-container {
      border-color: #666;
    }
    
    .track-markers {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
      pointer-events: none;
    }
    
    .track-start, .track-end {
      font-size: 1.2rem;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .rabbit {
      position: absolute;
      width: 40px;
      height: 40px;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      top: 5px;
      left: 5px;
      transition: left 0.5s ease-out;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
    }
    
    /* ANIMATIONS SP√âCIFIQUES PAR PROFIL POUR LE LAPIN */
    body[data-profile="CM1"] .rabbit {
      animation: rabbitBounce 0.8s infinite ease-in-out alternate;
    }
    
    body[data-profile="CM2"] .rabbit {
      animation: rabbitScale 1s infinite ease-in-out alternate;
    }
    
    body[data-profile="6EME"] .rabbit {
      animation: rabbitFade 1.5s infinite ease-in-out alternate;
    }
    
    body[data-profile="5EME"] .rabbit {
      animation: rabbitSubtle 2s infinite ease-in-out;
    }
    
    body[data-profile="ADULTE"] .rabbit {
      animation: none;
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
    }
    
    @keyframes rabbitBounce {
      0% { transform: translateY(0px) rotate(-5deg); }
      100% { transform: translateY(-8px) rotate(5deg); }
    }
    
    @keyframes rabbitScale {
      0% { transform: scale(1) rotate(0deg); }
      100% { transform: scale(1.15) rotate(10deg); }
    }
    
    @keyframes rabbitFade {
      0% { opacity: 0.8; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); }
      100% { opacity: 1; filter: drop-shadow(2px 2px 8px rgba(108, 92, 231, 0.7)); }
    }
    
    @keyframes rabbitSubtle {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-2px); }
    }
    
    .time-remaining {
      text-align: center;
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-night);
    }
    
    body.day-mode .time-remaining {
      color: var(--text-day);
    }
    
    .progress-info {
      font-size:1.2rem;
      margin-bottom:20px;
      color: var(--primary-color);
      text-align: center;
    }
    
    .progress-bar { 
      width:100%;
      height:12px;
      background: var(--card-night); 
      border-radius: 6px; 
      margin-bottom:30px; 
      overflow:hidden;
      border: 1px solid var(--primary-color);
    }
    
    body.day-mode .progress-bar {
      background:var(--card-day);
    }
    
    .progress-fill{
      height:100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width:0%;
      transition:width .5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
    }
    
    .progress-fill:after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 20px;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
      animation: progressShine 1.5s infinite;
    }
    
    @keyframes progressShine {
      0% { transform: translateX(-20px); }
      100% { transform: translateX(20px); }
    }
    
    .question { 
      font-size: 3rem; 
      font-weight: bold; 
      margin: 30px 0; 
      color: var(--primary-color);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    /* ANIMATIONS QUESTIONS PAR PROFIL */
    body[data-profile="CM1"] .question {
      animation: questionBounce 2s infinite ease-in-out;
    }
    
    body[data-profile="CM2"] .question {
      animation: questionPulse 2.5s infinite ease-in-out;
    }
    
    body[data-profile="6EME"] .question {
      animation: questionGlow 3s infinite ease-in-out;
    }
    
    @keyframes questionBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes questionPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    @keyframes questionGlow {
      0%, 100% { text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
      50% { text-shadow: 2px 2px 4px rgba(0,0,0,0.1), 0 0 10px var(--primary-color); }
    }
    
    .answer-input { 
      font-size:2rem; 
      padding:15px; 
      text-align:center; 
      border:3px solid var(--primary-color);
      border-radius: var(--border-radius); 
      background:var(--card-night); 
      color:var(--text-night); 
      width:200px; 
      margin:20px 0;
      transition: all 0.3s ease;
    }
    
    .answer-input:focus {
      outline: none;
      border-color: var(--secondary-color);
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    
    body.day-mode .answer-input{
      border-color: var(--primary-color);
      background:var(--card-day);
      color:var(--text-day);
    }
    
    .medal { 
      font-size:4rem;
      margin:20px 0;
      animation: medalSpin 2s infinite linear;
    }
    
    @keyframes medalSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ========== PAGE R√âSULTATS AVEC ANIMATIONS ========== */
    .results-area h2 {
      color: var(--primary-color); 
      margin-bottom: 25px;
      font-size: 2rem; 
      text-align: center;
      animation: resultsTitleSlide 0.8s ease-out;
    }
    
    @keyframes resultsTitleSlide {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .medal-message {
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      margin: 20px 0 30px 0;
      padding: 15px;
      border-radius: var(--border-radius);
      line-height: 1.4;
      animation: messageSlideIn 1s ease-out 0.5s both;
    }
    
    @keyframes messageSlideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .medal-message.gold {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #8B4513;
      border: 2px solid #DAA520;
    }
    
    .medal-message.silver {
      background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
      color: #2F4F4F;
      border: 2px solid #999999;
    }
    
    .medal-message.bronze {
      background: linear-gradient(135deg, #CD7F32, #B8860B);
      color: #FFFFFF;
      border: 2px solid #A0522D;
    }
    
    .medal-message.paper {
      background: linear-gradient(135deg, #F5F5F5, #E0E0E0);
      color: #555555;
      border: 2px solid #CCCCCC;
    }
    
    .score-blocks {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }
    
    .score-block {
      background: var(--card-night);
      border: 2px solid var(--primary-color);
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      animation: scoreBlockPop 0.6s ease-out both;
    }
    
    .score-block:nth-child(1) { animation-delay: 0.2s; }
    .score-block:nth-child(2) { animation-delay: 0.4s; }
    .score-block:nth-child(3) { animation-delay: 0.6s; }
    .score-block:nth-child(4) { animation-delay: 0.8s; }
    .score-block:nth-child(5) { animation-delay: 1s; }
    
    @keyframes scoreBlockPop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    body.day-mode .score-block {
      background: var(--card-day);
      border-color: var(--primary-color);
    }
    
    .score-block:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .score-label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 8px;
    }
    
    .score-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--text-night);
    }
    
    body.day-mode .score-value {
      color: var(--text-day);
    }
    
    .results-grid {overflow-x:auto; margin:30px 0;}
    
    .results-grid table {
      margin:0 auto; 
      border-collapse:collapse; 
      font-size:0.9rem;
    }
    
    .results-grid th, .results-grid td {
      border:1px solid var(--primary-color); 
      width:35px; 
      height:35px; 
      text-align:center; 
      font-weight:bold;
      transition: all 0.3s ease;
    }
    
    .results-grid th { 
      background: var(--primary-color);
      color:white;
    }
    
    .results-grid td:hover {
      transform: scale(1.1);
      z-index: 10;
      position: relative;
    }
    
    .cell-correct {background:transparent;}
    .cell-incorrect {background:#f44 !important; animation: cellError 0.5s ease-out;}
    .cell-missed {background:#ff0 !important; animation: cellMissed 0.5s ease-out;}
    
    @keyframes cellError {
      0% { background: transparent; }
      50% { background: #f44; transform: scale(1.2); }
      100% { background: #f44; transform: scale(1); }
    }
    
    @keyframes cellMissed {
      0% { background: transparent; }
      50% { background: #ff0; transform: scale(1.2); }
      100% { background: #ff0; transform: scale(1); }
    }
    
    /* Media queries pour autres √©l√©ments */
    @media (max-width:768px){
      .race-track {
        padding: 12px;
        margin-bottom: 15px;
      }
      
      .track-container {
        height: 40px;
      }
      
      .rabbit {
        width: 32px;
        height: 32px;
        font-size: 1.6rem;
        top: 4px;
        left: 4px;
      }
      
      .track-start, .track-end {
        font-size: 1rem;
      }
      
      .question{font-size:2rem;}
      .answer-input{font-size:1.5rem;width:150px;}
      .results-grid th, .results-grid td {width:25px;height:25px;font-size:0.8rem;}
      .table-num { font-size: 1.6rem; }
      .grid-tables { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .multiplication-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
      .modal-content { width: 95vw; padding: 25px; }
      .modal-title { font-size: 1.4rem; }
      .astuce-list li { font-size: 1rem; }
      
      .score-blocks {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }
      
      .score-block {
        padding: 15px;
      }
      
      .score-value {
        font-size: 1.5rem;
      }
      
      .medal-message {
        font-size: 1.1rem;
        padding: 12px;
      }
      
      .table-detail-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn-astuce, .btn-return {
        padding: 8px 16px;
        font-size: 1rem;
      }
      
      .stats-dashboard {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
    
    .footer {margin-top:auto;text-align:center;padding:30px;}
    .footer-logo img {height:40px;margin-bottom:10px;}
    .footer-text {font-size:0.9rem;opacity:0.8;}
    .hidden {display:none!important;}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- ========== HEADER ========== -->
    <header class="header">
      <div class="header-top">
        <div class="header-logo">
          <img src="logofTDSR.png" alt="Logo DSR" />
        </div>
        <div style="display: flex; gap: 8px;">
          <button id="settingsButtonMobile" class="btn-settings">
            <span class="gear-icon">‚öôÔ∏è</span>
          </button>
          <button id="themeToggle" class="btn-theme">
            <span class="theme-icon">üåô</span>
          </button>
        </div>
      </div>

      <div class="header-logo" style="display: none;">
        <img src="logofTDSR.png" alt="Logo DSR" />
      </div>
      
      <h1 class="app-title">TablesMathAssist</h1>
      
      <div style="display: none; gap: 10px;">
        <button id="settingsButtonDesktop" class="btn-settings">
          <span class="gear-icon">‚öôÔ∏è</span>
        </button>
        <button id="themeToggleDesktop" class="btn-theme">
          <span class="theme-icon">üåô</span>
        </button>
      </div>
    </header>

    <!-- ========== MODAL PARAM√àTRES ========== -->
    <div id="settingsModal" class="settings-modal-overlay">
      <div class="settings-modal-content">
        <div class="settings-modal-header">
          <h2>‚öôÔ∏è Param√®tres</h2>
          <button class="settings-modal-close" id="closeSettingsModal">&times;</button>
        </div>

        <div class="settings-section">
          <h3>üë§ Profil utilisateur</h3>
          <div class="profile-options">
            <label class="profile-option">
              <input type="radio" name="userProfile" value="CM1">
              <div class="profile-info">
                <div class="profile-label cm1-color">CM1 (9-10 ans)</div>
                <div class="profile-description">Tables 2, 3, 4, 5 prioritaires + autres jusqu'√† 10 ‚Ä¢ Interface color√©e et ludique ‚Ä¢ Animations bouncy</div>
              </div>
            </label>
            
            <label class="profile-option">
              <input type="radio" name="userProfile" value="CM2" checked>
              <div class="profile-info">
                <div class="profile-label cm2-color">CM2 (10-11 ans)</div>
                <div class="profile-description">Toutes les tables ‚Ä¢ Interface moderne ‚Ä¢ Animations scale</div>
              </div>
            </label>
            
            <label class="profile-option">
              <input type="radio" name="userProfile" value="6EME">
              <div class="profile-info">
                <div class="profile-label sixieme-color">6√®me (11-12 ans)</div>
                <div class="profile-description">R√©visions coll√®ge ‚Ä¢ Interface √©l√©gante ‚Ä¢ Animations glow</div>
              </div>
            </label>
            
            <label class="profile-option">
              <input type="radio" name="userProfile" value="5EME">
              <div class="profile-info">
                <div class="profile-label cinquieme-color">5√®me (12-13 ans)</div>
                <div class="profile-description">Perfectionnement ‚Ä¢ Design √©pur√© ‚Ä¢ Animations subtiles</div>
              </div>
            </label>
            
            <label class="profile-option">
              <input type="radio" name="userProfile" value="ADULTE">
              <div class="profile-info">
                <div class="profile-label adulte-color">Adulte/Enseignant</div>
                <div class="profile-description">Mode professionnel ‚Ä¢ Statistiques avanc√©es ‚Ä¢ Sans animations</div>
              </div>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <h3>üîä Pr√©f√©rences audio</h3>
          <label class="toggle-option">
            <input type="checkbox" id="soundsEnabled" checked>
            <span class="toggle-slider"></span>
            <span>Activer les sons et encouragements vocaux</span>
          </label>
        </div>

        <div class="settings-section">
          <h3>‚ú® Effets visuels</h3>
          <label class="toggle-option">
            <input type="checkbox" id="animationsEnabled" checked>
            <span class="toggle-slider"></span>
            <span>Activer les animations et transitions</span>
          </label>
        </div>

        <div class="settings-modal-footer">
          <button class="btn-save" id="saveSettingsBtn">üíæ Sauvegarder</button>
          <button class="btn-cancel" id="cancelSettingsBtn">‚ùå Annuler</button>
        </div>
      </div>
    </div>

    <!-- ========== PAGE ACCUEIL ========== -->
    <div id="homePage">
      <div class="welcome-message card">
        <p>L'application d√©di√©e aux √©l√®ves de CM1 √† la 5√®me pour un apprentissage parfait des tables de multiplications de 1 √† 12</p>
      </div>

      <section class="learn-panel card">
        <h2>Apprends tes tables ici</h2>
        <div class="welcome-section">
          <p style="font-size: 1.1rem; margin-bottom: 20px;">
            üìö D√©couvre les astuces et secrets de chaque table de multiplication !
          </p>
          <button id="learnBtn" class="btn-primary" style="background: #8e24aa;">Commencer √† apprendre</button>
        </div>
      </section>

      <!-- ========== STATISTIQUES AVANC√âES MODE ADULTE ========== -->
      <div class="stats-dashboard">
        <div class="stats-card">
          <h3>üìä Performances g√©n√©rales</h3>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>
        
        <div class="stats-card">
          <h3>üìà √âvolution temporelle</h3>
          <div class="chart-container">
            <canvas id="evolutionChart"></canvas>
          </div>
        </div>
      </div>

      <section class="settings-panel card">
        <div class="settings-motivating-message">
          <p>Choisis tes r√©glages et commences ton entra√Ænement ou mieux!!! Le test et gagnes la coupe. üèÜ</p>
        </div>
        
        <h2>R√©glages de ton Test</h2>
        
        <div class="form-group">
          <label class="form-label">Tables √† r√©viser :</label>
          <div class="tables-selector">
            <label><input type="checkbox" value="1" checked><span>1</span></label>
            <label><input type="checkbox" value="2" checked><span>2</span></label>
            <label><input type="checkbox" value="3" checked><span>3</span></label>
            <label><input type="checkbox" value="4" checked><span>4</span></label>
            <label><input type="checkbox" value="5" checked><span>5</span></label>
            <label><input type="checkbox" value="6" checked><span>6</span></label>
            <label><input type="checkbox" value="7" checked><span>7</span></label>
            <label><input type="checkbox" value="8" checked><span>8</span></label>
            <label><input type="checkbox" value="9" checked><span>9</span></label>
            <label><input type="checkbox" value="10" checked><span>10</span></label>
            <label><input type="checkbox" value="11"><span>11</span></label>
            <label><input type="checkbox" value="12"><span>12</span></label>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" id="timeLimitLabel">Temps pour ta s√©rie de 10 questions :</label>
          <select id="timeLimit">
            <option value="0.5">30 secondes</option>
            <option value="1" selected>1 minute</option>
            <option value="2">2 minutes</option>
            <option value="3">3 minutes</option>
            <option value="4">4 minutes</option>
            <option value="5">5 minutes</option>
            <option value="6">6 minutes</option>
            <option value="7">7 minutes</option>
            <option value="8">8 minutes</option>
            <option value="9">9 minutes</option>
            <option value="10">10 minutes</option>
            <option value="15">15 minutes</option>
            <option value="20">20 minutes</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Nombre de questions :</label>
          <select id="questionCount">
            <option value="10" selected>10 questions</option>
            <option value="20">20 questions</option>
            <option value="30">30 questions</option>
            <option value="40">40 questions</option>
            <option value="50">50 questions</option>
            <option value="60">60 questions</option>
            <option value="70">70 questions</option>
            <option value="80">80 questions</option>
            <option value="90">90 questions</option>
            <option value="100">100 questions</option>
            <option value="110">110 questions</option>
            <option value="120">120 questions</option>
            <option value="130">130 questions</option>
            <option value="140">140 questions</option>
            <option value="150">150 questions</option>
            <option value="160">160 questions</option>
            <option value="170">170 questions</option>
            <option value="180">180 questions</option>
            <option value="190">190 questions</option>
            <option value="200">200 questions</option>
            <option value="250">250 questions</option>
            <option value="300">300 questions</option>
            <option value="350">350 questions</option>
            <option value="400">400 questions</option>
            <option value="450">450 questions</option>
            <option value="500">500 questions</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="noTimerMode"> Mode entra√Ænement (sans chrono)
          </label>
        </div>
        
        <button id="startGame" class="btn-primary">Commencer le Test</button>
        
        <!-- BOUTONS EXPORT MODE ADULTE -->
        <div class="export-buttons">
          <button class="btn-export" id="exportCSV">üìä Export CSV</button>
          <button class="btn-export" id="exportPDF">üìÑ Export PDF</button>
          <button class="btn-export" id="modeClasse">üë• Mode Classe</button>
        </div>
      </section>
    </div>

    <!-- ========== PAGE APPRENTISSAGE ========== -->
    <div id="learnPage" class="card">
      <h2 class="learn-title">Apprentissage des Tables de 1 √† 12</h2>
      <p class="learn-sub">Clique sur une table pour apprendre ses secrets !</p>

      <div class="legend">
        <span><i style="background: #4caf50;"></i>Facile</span>
        <span><i style="background: #ff9800;"></i>Moyen</span>
        <span><i style="background: #f44336;"></i>Difficile</span>
      </div>

      <div class="grid-tables">
        <div class="table-card easy" data-num="1">
          <div class="table-num">1</div>
          Table de 1<br><span class="diff-label">FACILE</span>
        </div>
        <div class="table-card easy" data-num="2">
          <div class="table-num">2</div>
          Table de 2<br><span class="diff-label">FACILE</span>
        </div>
        <div class="table-card easy" data-num="5">
          <div class="table-num">5</div>
          Table de 5<br><span class="diff-label">FACILE</span>
        </div>
        <div class="table-card easy" data-num="10">
          <div class="table-num">10</div>
          Table de 10<br><span class="diff-label">FACILE</span>
        </div>
        <div class="table-card medium" data-num="3">
          <div class="table-num">3</div>
          Table de 3<br><span class="diff-label">MOYEN</span>
        </div>
        <div class="table-card medium" data-num="4">
          <div class="table-num">4</div>
          Table de 4<br><span class="diff-label">MOYEN</span>
        </div>
        <div class="table-card medium" data-num="6">
          <div class="table-num">6</div>
          Table de 6<br><span class="diff-label">MOYEN</span>
        </div>
        <div class="table-card medium" data-num="9">
          <div class="table-num">9</div>
          Table de 9<br><span class="diff-label">MOYEN</span>
        </div>
        <div class="table-card medium" data-num="11">
          <div class="table-num">11</div>
          Table de 11<br><span class="diff-label">MOYEN</span>
        </div>
        <div class="table-card hard" data-num="7">
          <div class="table-num">7</div>
          Table de 7<br><span class="diff-label">DIFFICILE</span>
        </div>
        <div class="table-card hard" data-num="8">
          <div class="table-num">8</div>
          Table de 8<br><span class="diff-label">DIFFICILE</span>
        </div>
        <div class="table-card hard" data-num="12">
          <div class="table-num">12</div>
          Table de 12<br><span class="diff-label">DIFFICILE</span>
        </div>
      </div>

      <div style="text-align: center; margin-top: 35px;">
        <button id="backHome" class="btn-primary">‚¨Ö Retour</button>
      </div>
    </div>

    <!-- ========== PAGE D√âTAIL TABLE ========== -->
    <div id="tableDetailPage" class="card">
      <div class="table-detail-header">
        <h2 id="tableDetailTitle" class="table-detail-title">Table de 2</h2>
        <div>
          <button id="showAstuceBtn" class="btn-astuce">üí° Astuce</button>
          <button id="backToLearnBtn" class="btn-return">‚Üê Retour</button>
        </div>
      </div>
      <div id="multiplicationGrid" class="multiplication-grid"></div>
    </div>

    <!-- ========== MODAL ASTUCES ========== -->
    <div id="astuceModal" class="modal-overlay">
      <div class="modal-content">
        <button id="closeAstuceModal" class="modal-close">√ó</button>
        <h3 id="astuceModalTitle" class="modal-title">Astuces Table de 2</h3>
        <ul id="astuceModalContent" class="astuce-list"></ul>
      </div>
    </div>

    <!-- ========== PAGE DE JEU ========== -->
    <section id="gameArea" class="game-area card">
      <div class="race-track" id="raceTrack">
        <div class="race-track-title">Course contre la montre !</div>
        <div class="track-container">
          <div class="track-markers">
            <div class="track-start">üöÄ</div>
            <div class="track-end">üèÅ</div>
          </div>
          <div class="rabbit" id="rabbit">üê∞</div>
        </div>
        <div class="time-remaining" id="timeRemaining">Temps restant: 5:00</div>
      </div>
      
      <div class="progress-info">
        <span id="progressText">Question 1 / 30</span>
      </div>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div id="question" class="question">7 √ó 8 = ?</div>
      <input type="number" id="answerInput" class="answer-input" placeholder="?">
      <br><br>
      <button id="validateBtn" class="btn-primary">Valider</button>
    </section>

    <!-- ========== PAGE R√âSULTATS ========== -->
    <section id="resultsArea" class="results-area card">
      <h2>R√©sultats de ton test</h2>
      <div id="medal" class="medal">üèÜ</div>
      <div id="medalText">OR</div>
      
      <div id="medalMessage" class="medal-message"></div>
      
      <div class="score-blocks">
        <div class="score-block">
          <div class="score-label">Score global</div>
          <div id="finalScore" class="score-value">0/30</div>
        </div>
        <div class="score-block">
          <div class="score-label">Bonnes r√©ponses</div>
          <div id="correctCount" class="score-value">0</div>
        </div>
        <div class="score-block">
          <div class="score-label">Mauvaises r√©ponses</div>
          <div id="incorrectCount" class="score-value">0</div>
        </div>
        <div class="score-block">
          <div class="score-label">Non r√©pondues</div>
          <div id="missedCount" class="score-value">0</div>
        </div>
        <div class="score-block">
          <div class="score-label">Pourcentage de r√©ussite</div>
          <div id="successPercentage" class="score-value">0%</div>
        </div>
      </div>
      
      <h3>Grille des r√©sultats 12√ó12 :</h3>
      <div class="results-grid">
        <table id="resultsGrid"></table>
      </div>
      
      <div style="margin:20px 0;">
        <div style="display:inline-block;margin:0 10px;">
          <span style="display:inline-block;width:20px;height:20px;background:transparent;border:1px solid #666;margin-right:5px;"></span>R√©ponse correcte
        </div>
        <div style="display:inline-block;margin:0 10px;">
          <span style="display:inline-block;width:20px;height:20px;background:#f44;margin-right:5px;"></span>R√©ponse incorrecte
        </div>
        <div style="display:inline-block;margin:0 10px;">
          <span style="display:inline-block;width:20px;height:20px;background:#ff0;margin-right:5px;"></span>Non r√©pondu
        </div>
      </div>
      
      <h3>Liste d√©taill√©e des erreurs :</h3>
      <div id="errorsList"></div>
      
      <button id="newGameBtn" class="btn-primary">Nouvelle s√©rie</button>
      <button id="backToSettingsBtn" class="btn-primary">Modifier les param√®tres</button>
    </section>

    <!-- ========== FOOTER ========== -->
    <footer class="footer">
      <div class="footer-logo">
        <img src="logofTDSR.png" alt="Logo DSR">
      </div>
      <div class="footer-text">
        Con√ßu et d√©velopp√© par DSR / edlam.dsr@gmail.com
      </div>
    </footer>
  </div>
  
  <script>
    // ========== CONFIGURATION PROFILS ADAPTATIFS AVANC√âS ==========
    const profileConfigs = {
      CM1: {
        tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
        colors: { primary: '#FF6B35', secondary: '#FFD23F', accent: '#06D6A0' },
        fontSize: '18px',
        animations: true,
        sounds: true,
        animationStyle: 'bounce',
        soundProfile: 'cheerful'
      },
      CM2: {
        tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        colors: { primary: '#4ECDC4', secondary: '#45B7D1', accent: '#FECA57' },
        fontSize: '16px',
        animations: true,
        sounds: true,
        animationStyle: 'scale',
        soundProfile: 'encouraging'
      },
      "6EME": {
        tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        colors: { primary: '#6C5CE7', secondary: '#74B9FF', accent: '#00B894' },
        fontSize: '15px',
        animations: true,
        sounds: true,
        animationStyle: 'glow',
        soundProfile: 'modern'
      },
      "5EME": {
        tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        colors: { primary: '#2D3436', secondary: '#636E72', accent: '#00CEC9' },
        fontSize: '14px',
        animations: true,
        sounds: false,
        animationStyle: 'subtle',
        soundProfile: 'minimal'
      },
      ADULTE: {
        tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        colors: { primary: '#2F3640', secondary: '#57606F', accent: '#3742FA' },
        fontSize: '13px',
        animations: false,
        sounds: false,
        animationStyle: 'none',
        soundProfile: 'none',
        advancedStats: true,
        exportFeatures: true,
        classMode: true
      }
    };

    // ========== SYST√àME SONORE ADAPTATIF ==========
    let audioContext = null;
    let soundBank = {};

    function initAudioSystem() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('üîä Syst√®me audio initialis√©');
      } catch (error) {
        console.warn('‚ö†Ô∏è Audio non support√©:', error);
      }
    }

    function createBeepSound(frequency, duration, type = 'sine') {
      if (!audioContext) return;
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
      oscillator.type = type;
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration);
    }

    function playSuccessSound(profile) {
      if (!window.tmaSoundsEnabled) return;
      
      const config = profileConfigs[profile] || profileConfigs.CM2;
      
      switch (config.soundProfile) {
        case 'cheerful':
          // S√©rie joyeuse pour CM1
          createBeepSound(523, 0.2, 'square'); // Do
          setTimeout(() => createBeepSound(659, 0.2, 'square'), 100); // Mi
          setTimeout(() => createBeepSound(784, 0.3, 'square'), 200); // Sol
          break;
          
        case 'encouraging':
          // Accord encourageant pour CM2
          createBeepSound(440, 0.3, 'sine'); // La
          setTimeout(() => createBeepSound(554, 0.3, 'sine'), 150); // Do#
          break;
          
        case 'modern':
          // Son moderne pour 6√®me
          createBeepSound(330, 0.2, 'triangle');
          setTimeout(() => createBeepSound(440, 0.25, 'sawtooth'), 100);
          break;
          
        case 'minimal':
          // Son discret pour 5√®me
          createBeepSound(440, 0.15, 'sine');
          break;
          
        default:
          // Pas de son pour Adulte
          break;
      }
    }

    function playErrorSound(profile) {
      if (!window.tmaSoundsEnabled) return;
      
      const config = profileConfigs[profile] || profileConfigs.CM2;
      
      if (config.soundProfile !== 'none' && config.soundProfile !== 'minimal') {
        createBeepSound(200, 0.3, 'sawtooth'); // Son d'erreur grave
      }
    }

    function playValidationSound(profile) {
      if (!window.tmaSoundsEnabled) return;
      
      const config = profileConfigs[profile] || profileConfigs.CM2;
      
      switch (config.soundProfile) {
        case 'cheerful':
        case 'encouraging':
          createBeepSound(800, 0.1, 'sine');
          break;
          
        case 'modern':
          createBeepSound(600, 0.1, 'triangle');
          break;
          
        default:
          break;
      }
    }

    // ========== STATISTIQUES AVANC√âES MODE ADULTE ==========
    let performanceChart = null;
    let evolutionChart = null;
    let statsData = {
      sessions: [],
      tablePerformance: {},
      timeAnalysis: {},
      errorPatterns: []
    };

    function initAdvancedStats() {
      if (document.body.getAttribute('data-profile') === 'ADULTE') {
        initPerformanceChart();
        initEvolutionChart();
        loadStatsData();
      }
    }

    function initPerformanceChart() {
      const ctx = document.getElementById('performanceChart');
      if (!ctx) return;
      
      performanceChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Table 1', 'Table 2', 'Table 3', 'Table 4', 'Table 5', 'Table 6', 'Table 7', 'Table 8', 'Table 9', 'Table 10', 'Table 11', 'Table 12'],
          datasets: [{
            label: 'Taux de r√©ussite (%)',
            data: [95, 88, 82, 79, 92, 75, 68, 71, 77, 98, 73, 69],
            backgroundColor: 'rgba(47, 54, 64, 0.1)',
            borderColor: '#2F3640',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function initEvolutionChart() {
      const ctx = document.getElementById('evolutionChart');
      if (!ctx) return;
      
      evolutionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Session 1', 'Session 2', 'Session 3', 'Session 4', 'Session 5', 'Session 6', 'Session 7'],
          datasets: [{
            label: 'Score moyen (%)',
            data: [65, 71, 78, 82, 88, 85, 91],
            borderColor: '#3742FA',
            backgroundColor: 'rgba(55, 66, 250, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function updateStatsCharts(gameResults) {
      if (!performanceChart || !evolutionChart) return;
      
      // Mettre √† jour les donn√©es des graphiques
      const tableStats = calculateTablePerformance(gameResults);
      performanceChart.data.datasets[0].data = tableStats;
      performanceChart.update();
      
      // Ajouter nouvelle session √† l'√©volution
      const sessionScore = Math.round(gameResults.score / gameResults.total * 100);
      evolutionChart.data.datasets[0].data.push(sessionScore);
      evolutionChart.data.labels.push(`Session ${evolutionChart.data.labels.length + 1}`);
      
      // Garder seulement les 10 derni√®res sessions
      if (evolutionChart.data.labels.length > 10) {
        evolutionChart.data.labels.shift();
        evolutionChart.data.datasets[0].data.shift();
      }
      
      evolutionChart.update();
    }

    function calculateTablePerformance(results) {
      const tableStats = new Array(12).fill(0);
      const tableCounts = new Array(12).fill(0);
      
      results.questions.forEach((q, index) => {
        const tableIndex = q.a - 1;
        tableCounts[tableIndex]++;
        
        if (results.answers[index] === q.result) {
          tableStats[tableIndex]++;
        }
      });
      
      return tableStats.map((correct, i) => 
        tableCounts[i] > 0 ? Math.round((correct / tableCounts[i]) * 100) : 0
      );
    }

    function saveStatsData() {
      localStorage.setItem('tma_advanced_stats', JSON.stringify(statsData));
    }

    function loadStatsData() {
      const saved = localStorage.getItem('tma_advanced_stats');
      if (saved) {
        statsData = JSON.parse(saved);
      }
    }

    // ========== EXPORT FONCTIONNALIT√âS ==========
    function exportToCSV() {
      if (!statsData.sessions.length) {
        alert('Aucune donn√©e √† exporter');
        return;
      }
      
      let csv = 'Session,Date,Score,Bonnes Reponses,Mauvaises Reponses,Temps Total\n';
      
      statsData.sessions.forEach((session, index) => {
        csv += `${index + 1},${session.date},${session.score}%,${session.correct},${session.incorrect},${session.duration}s\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tablesmathassist_stats.csv';
      a.click();
      window.URL.revokeObjectURL(url);
      
      showNotification('üìä Statistiques export√©es en CSV !');
    }

    function exportToPDF() {
      // Simulation d'export PDF
      showNotification('üìÑ Export PDF en cours de d√©veloppement...');
    }

    function activateClassMode() {
      showNotification('üë• Mode Classe activ√© ! Fonctionnalit√© en d√©veloppement...');
    }

    // ========== GESTION MODAL PARAM√àTRES ==========
    const settingsModal = document.getElementById('settingsModal');
    const settingsButtonMobile = document.getElementById('settingsButtonMobile');
    const settingsButtonDesktop = document.getElementById('settingsButtonDesktop');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
    const soundsEnabledInput = document.getElementById('soundsEnabled');
    const animationsEnabledInput = document.getElementById('animationsEnabled');

    // Event listeners pour boutons export
    document.getElementById('exportCSV')?.addEventListener('click', exportToCSV);
    document.getElementById('exportPDF')?.addEventListener('click', exportToPDF);
    document.getElementById('modeClasse')?.addEventListener('click', activateClassMode);

    // Cl√©s localStorage pour le syst√®me de param√®tres
    const LS_PROFILE = 'tma_profile';
    const LS_SOUNDS = 'tma_sounds';
    const LS_ANIMATIONS = 'tma_animations';

    function openSettings() {
      loadCurrentSettings();
      settingsModal.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Son d'ouverture selon le profil
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      playValidationSound(profile);
    }

    function closeSettings() {
      settingsModal.classList.remove('active');
      document.body.style.overflow = '';
    }

    function loadCurrentSettings() {
      const profile = localStorage.getItem(LS_PROFILE) || 'CM2';
      const profileRadio = document.querySelector(`input[name="userProfile"][value="${profile}"]`);
      if (profileRadio) {
        profileRadio.checked = true;
      }
      
      soundsEnabledInput.checked = (localStorage.getItem(LS_SOUNDS) !== 'false');
      animationsEnabledInput.checked = (localStorage.getItem(LS_ANIMATIONS) !== 'false');
    }

    function saveSettings() {
      const selectedProfileElement = document.querySelector('input[name="userProfile"]:checked');
      if (!selectedProfileElement) {
        alert('Veuillez s√©lectionner un profil utilisateur');
        return;
      }
      
      const selectedProfile = selectedProfileElement.value;
      const soundsEnabled = soundsEnabledInput.checked;
      const animationsEnabled = animationsEnabledInput.checked;
      
      // Sauvegarder dans localStorage
      localStorage.setItem(LS_PROFILE, selectedProfile);
      localStorage.setItem(LS_SOUNDS, soundsEnabled);
      localStorage.setItem(LS_ANIMATIONS, animationsEnabled);
      localStorage.setItem('tma_settings_timestamp', Date.now());
      
      // Appliquer les changements
      applyProfileSettings(selectedProfile);
      
      // Son de succ√®s selon le profil
      playSuccessSound(selectedProfile);
      
      // Notification de succ√®s avec animation
      showNotification('üéâ Param√®tres sauvegard√©s avec succ√®s !');
      
      // Fermer le modal avec d√©lai pour voir l'animation
      setTimeout(closeSettings, 300);
    }

    function applyProfileSettings(profile) {
      const config = profileConfigs[profile] || profileConfigs.CM2;
      
      // Appliquer l'attribut data-profile au body
      document.body.setAttribute('data-profile', profile);
      
      // D√©finir les variables globales
      window.tmaAnimationsEnabled = (localStorage.getItem(LS_ANIMATIONS) !== 'false') && config.animations;
      window.tmaSoundsEnabled = (localStorage.getItem(LS_SOUNDS) !== 'false') && config.sounds;
      
      // Mettre √† jour la visibilit√© des tables
      updateVisibleTables(config.tables);
      
      // Forcer la mise √† jour des checkboxes selon le profil
      updateTablesCheckboxesByProfile(profile);
      
      // Initialiser les statistiques avanc√©es si profil Adulte
      if (profile === 'ADULTE') {
        setTimeout(initAdvancedStats, 100);
      }
      
      console.log('‚úÖ Profil appliqu√©:', profile, 'Sons:', window.tmaSoundsEnabled, 'Animations:', window.tmaAnimationsEnabled);
    }

    function updateVisibleTables(allowedTables) {
      const tableCards = document.querySelectorAll('.table-card');
      tableCards.forEach(card => {
        const tableNum = parseInt(card.dataset.num);
        if (allowedTables.includes(tableNum)) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });
    }

    function updateTablesCheckboxesByProfile(profile) {
      const config = profileConfigs[profile] || profileConfigs.CM2;
      const checkboxes = document.querySelectorAll('.tables-selector input[type="checkbox"]');
      
      checkboxes.forEach(checkbox => {
        const tableNum = parseInt(checkbox.value);
        if (profile === 'CM1') {
          // CM1 : Tables 2,3,4,5 prioritaires + autres jusqu'√† 10
          if ([2,3,4,5].includes(tableNum)) {
            checkbox.checked = true;
          } else if (tableNum <= 10) {
            checkbox.checked = false; // Disponibles mais non coch√©es par d√©faut
          } else {
            checkbox.checked = false;
            checkbox.disabled = true; // Tables 11-12 d√©sactiv√©es
          }
        } else {
          // Autres profils : toutes les tables disponibles
          checkbox.disabled = false;
          if (config.tables.includes(tableNum)) {
            checkbox.checked = (tableNum <= 10); // Tables 1-10 coch√©es par d√©faut
          } else {
            checkbox.checked = false;
          }
        }
      });
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 15px 20px;
        border-radius: 12px;
        z-index: 3000;
        font-size: 1rem;
        font-weight: bold;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: notificationSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 300px;
      `;
      notification.textContent = message;
      
      if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          @keyframes notificationSlideIn {
            from { transform: translateX(400px) rotate(10deg); opacity: 0; }
            to { transform: translateX(0) rotate(0); opacity: 1; }
          }
          @keyframes notificationSlideOut {
            from { transform: translateX(0) scale(1); opacity: 1; }
            to { transform: translateX(400px) scale(0.8); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'notificationSlideOut 0.4s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 400);
      }, 3500);
    }

    // Event listeners pour le modal param√®tres
    settingsButtonMobile.onclick = openSettings;
    settingsButtonDesktop.onclick = openSettings;
    closeSettingsModal.onclick = closeSettings;
    cancelSettingsBtn.onclick = closeSettings;
    saveSettingsBtn.onclick = saveSettings;

    // Fermer le modal en cliquant √† l'ext√©rieur
    settingsModal.onclick = (e) => {
      if (e.target === settingsModal) {
        closeSettings();
      }
    };

    // ========== PHRASES AL√âATOIRES POUR M√âDAILLES ==========
    const MEDAL_MESSAGES = {
      gold: [
        "Tu as gagn√© la coupe OR, f√©licitations tu as r√©ussi une vraie prouesse !",
        "Incroyable ! Tu ma√Ætrises parfaitement tes tables, c'est de l'OR pur !",
        "Champion(ne) ! Ton r√©sultat est exceptionnel, tu m√©rites cette m√©daille d'OR !",
        "Bravo ! Tu es un(e) v√©ritable expert(e) des tables de multiplication !",
        "Extraordinaire ! Tu as atteint l'excellence, cette m√©daille d'OR est bien m√©rit√©e !",
        "Fantastique ! Ton niveau est remarquable, tu peux √™tre fier(e) de toi !",
        "Exceptionnel ! Tu as d√©montr√© une ma√Ætrise parfaite, f√©licitations !",
        "Impressionnant ! Tes efforts ont pay√©, tu es au sommet !",
        "Magnifique ! Tu as brill√© comme de l'or, continue comme √ßa !",
        "Parfait ! Tu es un(e) champion(ne) des math√©matiques !"
      ],
      silver: [
        "Tr√®s bien ! Tu as d√©croch√© la m√©daille d'ARGENT, c'est un excellent r√©sultat !",
        "Bravo ! Ton travail s√©rieux t'a men√© √† cette belle m√©daille d'ARGENT !",
        "Super ! Tu es sur la bonne voie, cette m√©daille d'ARGENT le prouve !",
        "F√©licitations ! Ton niveau est tr√®s bon, tu peux √™tre fier(e) !",
        "Bien jou√© ! Cette m√©daille d'ARGENT r√©compense tes efforts !",
        "Excellent travail ! Tu ma√Ætrises bien tes tables, continue !",
        "Tr√®s bon r√©sultat ! Cette m√©daille d'ARGENT est m√©rit√©e !",
        "Bravo ! Tu progresses bien, cette m√©daille le confirme !",
        "Super performance ! Tu es en bonne voie vers l'excellence !",
        "Tr√®s bien ! Tes r√©visions portent leurs fruits !"
      ],
      bronze: [
        "Bien ! Tu as obtenu la m√©daille de BRONZE, c'est un bon d√©but !",
        "Pas mal ! Cette m√©daille de BRONZE montre que tu progresses !",
        "Bravo ! Tu as travaill√© et cette m√©daille de BRONZE le r√©compense !",
        "C'est un bon r√©sultat ! Continue tes efforts pour progresser !",
        "Bien jou√© ! Cette m√©daille de BRONZE est encourageante !",
        "Tu y arrives ! Tes efforts commencent √† payer !",
        "Correct ! Tu es sur le bon chemin, pers√©v√®re !",
        "Pas mal du tout ! Continue √† t'entra√Æner !",
        "C'est bien ! Tu peux encore mieux faire, courage !",
        "Bon travail ! Cette m√©daille te motive pour la suite !"
      ],
      paper: [
        "Ne te d√©courage pas ! Avec plus d'entra√Ænement, tu vas y arriver !",
        "Courage ! Les tables demandent de la pratique, continue !",
        "Pas grave ! Chaque erreur est une le√ßon, recommence !",
        "Allez ! Avec de la pers√©v√©rance, tu vas progresser !",
        "C'est en forgeant qu'on devient forgeron, continue !",
        "Ne baisse pas les bras ! La r√©ussite demande du temps !",
        "Courage ! Retravailles tes tables et tu vas y arriver !",
        "Pas de panique ! Avec plus d'entra√Ænement, √ßa viendra !",
        "Continue ! Chaque tentative te rapproche du succ√®s !",
        "Pers√©v√®re ! Les math√©matiques s'apprennent avec la pratique !"
      ]
    };

    // ========== FONCTION MESSAGE AL√âATOIRE ==========
    function getRandomMedalMessage(medalType) {
      const messages = MEDAL_MESSAGES[medalType];
      const randomIndex = Math.floor(Math.random() * messages.length);
      return messages[randomIndex];
    }

    // ========== ANIMATION DU LI√àVRE ==========
    function updateRabbitPosition() {
      if (!GAME.noTimerMode && GAME.timeLimit > 0) {
        const timeElapsed = (GAME.timeLimit - GAME.timeLeft) / GAME.timeLimit;
        const trackWidth = document.querySelector('.track-container').offsetWidth - 40;
        const rabbitPosition = Math.min(timeElapsed * trackWidth, trackWidth);
        
        const rabbit = document.getElementById('rabbit');
        if (rabbit) {
          rabbit.style.left = `${rabbitPosition + 5}px`;
        }
        
        const timeRemaining = document.getElementById('timeRemaining');
        if (timeRemaining) {
          const minutes = Math.floor(GAME.timeLeft / 60);
          const seconds = GAME.timeLeft % 60;
          timeRemaining.textContent = `Temps restant: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      }
    }

    // ========== TH√àME + BOUTONS DOUBLES ==========
    const themeToggle = document.getElementById('themeToggle');
    const themeToggleDesktop = document.getElementById('themeToggleDesktop');
    const themeIcons = document.querySelectorAll('.theme-icon');
    
    function setTheme(mode) {
      document.body.classList.toggle('day-mode', mode === 'day');
      themeIcons.forEach(icon => {
        icon.textContent = (mode === 'day') ? '‚òÄÔ∏è' : 'üåô';
      });
      localStorage.setItem('tma_theme', mode);
    }
    
    let currentTheme = localStorage.getItem('tma_theme') || 'night';
    setTheme(currentTheme);

    function toggleTheme() {
      currentTheme = (currentTheme === 'day') ? 'night' : 'day';
      setTheme(currentTheme);
      
      // Son de changement de th√®me
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      playValidationSound(profile);
    }
    
    themeToggle.onclick = toggleTheme;
    themeToggleDesktop.onclick = toggleTheme;

    // ========== AFFICHAGE CONDITIONNEL DESKTOP/MOBILE ==========
    function updateHeaderLayout() {
      const isMobile = window.innerWidth <= 768;
      const desktopLogo = document.querySelector('.header-logo:not(.header-top .header-logo)');
      const desktopButtons = document.querySelector('.header > div:last-child');
      
      if (isMobile) {
        if (desktopLogo) desktopLogo.style.display = 'none';
        if (desktopButtons) desktopButtons.style.display = 'none';
      } else {
        if (desktopLogo) desktopLogo.style.display = 'block';
        if (desktopButtons) desktopButtons.style.display = 'flex';
      }
    }
    
    updateHeaderLayout();
    window.addEventListener('resize', updateHeaderLayout);

    // ========== NOUVELLES ASTUCES COMPL√àTES ==========
    const ASTUCES = {
      1: [
        "üü¢ C'est tr√®s facile ! Quand tu multiplies par 1, le nombre ne change jamais !",
        "‚Ä¢ Tu vois, 1 √ó 5 = 5, comme si tu avais 1 paquet de 5 bonbons = 5 bonbons",
        "‚Ä¢ C'est pareil avec tous les nombres : 1 √ó 8 = 8, 1 √ó 12 = 12",
        "‚Ä¢ Astuce : Le nombre 1 est comme un miroir, il ne change rien au nombre !",
        "‚Ä¢ Pour t'entra√Æner : dis tout haut '1 fois 7 √©gale 7' plusieurs fois"
      ],
      
      2: [
        "üü¢ La table de 2, c'est tr√®s simple : tu doubles le nombre !",
        "‚Ä¢ Doubler, √ßa veut dire prendre deux fois la m√™me chose",
        "‚Ä¢ Par exemple : 2 √ó 4, c'est comme avoir 4 + 4 = 8",
        "‚Ä¢ Tu peux compter de 2 en 2 : 2, 4, 6, 8, 10, 12, 14, 16, 18, 20...",
        "‚Ä¢ Astuce magique : tous les r√©sultats finissent par 0, 2, 4, 6 ou 8 !",
        "‚Ä¢ Imagine 2 paquets identiques de biscuits, combien as-tu en tout ?"
      ],
      
      3: [
        "üü† Pour la table de 3, compte de 3 en 3 comme en sautant √† la marelle !",
        "‚Ä¢ R√©cite cette suite magique : 3, 6, 9, 12, 15, 18, 21, 24, 27, 30...",
        "‚Ä¢ Pour calculer 3 √ó 4, imagine 4 paquets de 3 bonbons chacun",
        "‚Ä¢ Tu peux aussi faire 3 + 3 + 3 + 3 = 12",
        "‚Ä¢ Astuce amusante : dessine 3 ronds, puis encore 3, puis encore 3...",
        "‚Ä¢ C'est comme faire 3 pas, puis 3 pas, puis 3 pas !"
      ],
      
      4: [
        "üü† La table de 4, c'est comme doubler deux fois !",
        "‚Ä¢ D'abord tu doubles le nombre, puis tu doubles encore le r√©sultat",
        "‚Ä¢ Exemple : 4 √ó 3 ‚Üí d'abord 3 + 3 = 6, puis 6 + 6 = 12",
        "‚Ä¢ Tu peux r√©citer : 4, 8, 12, 16, 20, 24, 28, 32, 36, 40...",
        "‚Ä¢ Astuce : 4, c'est 2 + 2, alors fais deux fois la table de 2 !",
        "‚Ä¢ Pense √† 4 roues sur une voiture, combien de roues sur plusieurs voitures ?"
      ],
      
      5: [
        "üü¢ Super facile ! Tous les r√©sultats de la table de 5 finissent par 0 ou 5 !",
        "‚Ä¢ R√©cite : 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60...",
        "‚Ä¢ R√®gle magique : nombre pair √ó 5 = r√©sultat qui finit par 0",
        "‚Ä¢ R√®gle magique : nombre impair √ó 5 = r√©sultat qui finit par 5", 
        "‚Ä¢ Compte sur tes doigts : une main compl√®te = 5 !",
        "‚Ä¢ Pense aux pi√®ces de 5 centimes dans ta tirelire !"
      ],
      
      6: [
        "üü† Pour la table de 6, apprends cette suite comme une chanson !",
        "‚Ä¢ Chante : 6, 12, 18, 24, 30, 36, 42, 48, 54, 60, 66, 72...",
        "‚Ä¢ Utilise tes doigts : sur chaque doigt, dis 6, 12, 18, 24, 30, 36...",
        "‚Ä¢ Astuce : 6 √ó nombre pair donne un r√©sultat qui finit par 2, 4, 6, 8 ou 0",
        "‚Ä¢ Pense aux ≈ìufs : une bo√Æte de 6 ≈ìufs, combien d'≈ìufs dans plusieurs bo√Ætes ?",
        "‚Ä¢ Pour retenir : invente une petite chanson avec ces nombres !"
      ],
      
      7: [
        "üî¥ Pense aux jours de la semaine pour retenir la table de 7 !",
        "‚Ä¢ Il y a 7 jours dans une semaine, 14 jours dans 2 semaines...",
        "‚Ä¢ Souviens-toi : 7 √ó 4 = 28 (c'est 4 semaines, presque 1 mois !)",
        "‚Ä¢ Truc pour retenir : 7 √ó 8 = 56 (sept-huit font cinquante-six)",
        "‚Ä¢ R√©cite : 7, 14, 21, 28, 35, 42, 49, 56, 63, 70, 77, 84...",
        "‚Ä¢ Compte les jours sur un calendrier pour t'aider !"
      ],
      
      8: [
        "üî¥ La table de 8, c'est comme doubler 3 fois de suite !",
        "‚Ä¢ Pour 8 √ó 2 : prends 2, double-le (2+2=4), double encore (4+4=8), double encore (8+8=16)",
        "‚Ä¢ Astuce : 8 c'est 2√ó2√ó2, alors triple le doublement !",
        "‚Ä¢ R√©cite : 8, 16, 24, 32, 40, 48, 56, 64, 72, 80, 88, 96...",
        "‚Ä¢ Pense aux pattes d'une araign√©e : 8 pattes sur une araign√©e !",
        "‚Ä¢ Pour t'aider : √©cris la table et colorie-la pour mieux la retenir"
      ],
      
      9: [
        "üü† La table de 9 a un secret magique incroyable !",
        "‚Ä¢ Secret : additionne les chiffres du r√©sultat, tu obtiens toujours 9 !",
        "‚Ä¢ Exemple : 9 √ó 4 = 36, et 3 + 6 = 9 !",
        "‚Ä¢ Autre exemple : 9 √ó 7 = 63, et 6 + 3 = 9 !",
        "‚Ä¢ Astuce avec les doigts : pour 9√ó3, baisse ton 3√®me doigt, lis 27 !",
        "‚Ä¢ R√©cite : 9, 18, 27, 36, 45, 54, 63, 72, 81, 90, 99, 108..."
      ],
      
      10: [
        "üü¢ La plus facile de toutes ! Tu ajoutes juste un 0 !",
        "‚Ä¢ 10 √ó 7 = 70 (√©cris 7 puis ajoute 0)",
        "‚Ä¢ 10 √ó 12 = 120 (√©cris 12 puis ajoute 0)",
        "‚Ä¢ Astuce magique : le 10 transforme tous les nombres !",
        "‚Ä¢ R√©cite : 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120...",
        "‚Ä¢ Pense aux pi√®ces de 10 centimes ou aux billets de 10 euros !"
      ],
      
      11: [
        "üü† Pour les nombres de 1 √† 9, √©cris le chiffre deux fois !",
        "‚Ä¢ 11 √ó 4 = 44 (√©cris 4, puis encore 4)",
        "‚Ä¢ 11 √ó 7 = 77 (√©cris 7, puis encore 7)",
        "‚Ä¢ Attention : pour 10, 11, 12 c'est diff√©rent mais facile √† retenir !",
        "‚Ä¢ R√©cite : 11, 22, 33, 44, 55, 66, 77, 88, 99, 110, 121, 132...",
        "‚Ä¢ Astuce visuelle : tous les r√©sultats jusqu'√† 9 ont des chiffres jumeaux !"
      ],
      
      12: [
        "üî¥ La table de 12, c'est la table des douzaines !",
        "‚Ä¢ Une douzaine = 12, comme une bo√Æte de 12 ≈ìufs !",
        "‚Ä¢ R√©cite : 12, 24, 36, 48, 60, 72, 84, 96, 108, 120, 132, 144...",
        "‚Ä¢ 12 √ó 5 = 60 (5 douzaines d'≈ìufs font 60 ≈ìufs)",
        "‚Ä¢ Astuce : 12 = 10 + 2, alors 12√ó4 = (10√ó4) + (2√ó4) = 40+8 = 48",
        "‚Ä¢ Pense aux heures sur une horloge : 12 heures !"
      ]
    };

    // ========== NAVIGATION APPRENTISSAGE ==========
    const learnBtn = document.getElementById('learnBtn');
    const learnPage = document.getElementById('learnPage');
    const homePage = document.getElementById('homePage');
    const backHome = document.getElementById('backHome');
    const tableDetailPage = document.getElementById('tableDetailPage');
    const backToLearnBtn = document.getElementById('backToLearnBtn');
    let currentTableNum = 1;

    learnBtn.onclick = () => {
      homePage.style.display = 'none';
      learnPage.style.display = 'block';
      tableDetailPage.style.display = 'none';
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('resultsArea').style.display = 'none';
      window.scrollTo(0, 0);
      
      // Son de navigation
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      playValidationSound(profile);
    };
    
    backHome.onclick = () => {
      learnPage.style.display = 'none';
      tableDetailPage.style.display = 'none';
      homePage.style.display = 'block';
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('resultsArea').style.display = 'none';
      window.scrollTo(0, 0);
      
      // Son de navigation
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      playValidationSound(profile);
    };
    
    backToLearnBtn.onclick = () => {
      tableDetailPage.style.display = 'none';
      learnPage.style.display = 'block';
      window.scrollTo(0, 0);
      
      // Son de navigation
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      playValidationSound(profile);
    };

    document.querySelectorAll('.table-card').forEach(card => {
      card.onclick = () => {
        currentTableNum = parseInt(card.dataset.num);
        showTableDetail(currentTableNum);
        
        // Son de s√©lection
        const profile = document.body.getAttribute('data-profile') || 'CM2';
        playValidationSound(profile);
      };
    });

    function showTableDetail(tableNum) {
      learnPage.style.display = 'none';
      tableDetailPage.style.display = 'block';
      document.getElementById('tableDetailTitle').textContent = `Table de ${tableNum}`;
      const grid = document.getElementById('multiplicationGrid');
      grid.innerHTML = '';
      for (let i = 1; i <= 12; i++) {
        const card = document.createElement('div');
        card.className = 'mult-card';
        card.innerHTML = `<div class="mult-question">${tableNum} √ó ${i} =</div><div class="mult-answer">${tableNum * i}</div>`;
        grid.appendChild(card);
      }
      window.scrollTo(0, 0);
    }

    // ========== MODAL ASTUCES ==========
    const showAstuceBtn = document.getElementById('showAstuceBtn');
    const astuceModal = document.getElementById('astuceModal');
    const closeAstuceModal = document.getElementById('closeAstuceModal');
    const astuceModalTitle = document.getElementById('astuceModalTitle');
    const astuceModalContent = document.getElementById('astuceModalContent');

    showAstuceBtn.onclick = () => {
      astuceModalTitle.textContent = `Astuces Table de ${currentTableNum}`;
      astuceModalContent.innerHTML = '';
      ASTUCES[currentTableNum].forEach(astuce => {
        const li = document.createElement('li');
        li.textContent = astuce;
        astuceModalContent.appendChild(li);
      });
      astuceModal.classList.add('active');
      
      // Son d'ouverture astuce
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      playValidationSound(profile);
    };
    
    closeAstuceModal.onclick = () => astuceModal.classList.remove('active');
    
    astuceModal.onclick = (e) => {
      if (e.target === astuceModal) astuceModal.classList.remove('active');
    };

    // ========== PR√âF√âRENCES ==========
    const prefsKey = 'tma_prefs_v2';
    
    function savePrefs() {
      localStorage.setItem(prefsKey, JSON.stringify({
        tables: getTables(),
        questionCount: questionCount.value,
        timeLimit: timeLimit.value,
        noTimerMode: noTimerMode.checked
      }));
    }
    
    function loadPrefs() {
      const p = JSON.parse(localStorage.getItem(prefsKey)||'null');
      if (!p) return;
      document.querySelectorAll('.tables-selector input').forEach((cb,i) => cb.checked=(p.tables||[]).includes(i+1));
      questionCount.value = p.questionCount||"10";
      timeLimit.value = p.timeLimit||"1";
      noTimerMode.checked = !!p.noTimerMode;
      updateTimeLimitLabel();
      updateButtonText();
    }
    
    const questionCount = document.getElementById('questionCount');
    const timeLimit = document.getElementById('timeLimit');
    const timeLimitLabel = document.getElementById('timeLimitLabel');
    const noTimerMode = document.getElementById('noTimerMode');
    
    function updateTimeLimitLabel() {
      timeLimitLabel.textContent = `Temps pour ta s√©rie de ${questionCount.value} questions :`;
    }
    
    questionCount.addEventListener('change', () => {
      updateTimeLimitLabel(); 
      savePrefs();
    });
    
    timeLimit.addEventListener('change', savePrefs);
    noTimerMode.addEventListener('change', () => {updateButtonText();savePrefs();});
    
    // ========== CORRECTION CHECKBOXES TABLES ==========
    document.querySelectorAll('.tables-selector input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        console.log(`Checkbox ${e.target.value} changed to:`, e.target.checked);
        
        // Son de validation selon profil
        const profile = document.body.getAttribute('data-profile') || 'CM2';
        playValidationSound(profile);
        
        savePrefs();
      });
    });
    
    const startGame = document.getElementById('startGame');
    
    function updateButtonText(){
      startGame.textContent = noTimerMode.checked ? "Commencer l'entra√Ænement" : "Commencer le Test";
    }
    
    loadPrefs();

    // ========== LOGIQUE DE JEU ==========
    let GAME = {};
    
    function getTables(){
      return Array.from(document.querySelectorAll('.tables-selector input:checked')).map(cb=>parseInt(cb.value));
    }
    
    function updateProgressBar(){
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      progressFill.style.width = ((GAME.idx)/GAME.nbQuestions*100)+'%';
      progressText.textContent = `Question ${Math.min(GAME.idx+1,GAME.nbQuestions)} / ${GAME.nbQuestions}`;
    }
    
    function updateTimerDisplay(){
      if (GAME.noTimerMode) {
        const raceTrack = document.getElementById('raceTrack');
        if (raceTrack) raceTrack.style.display = 'none';
      } else {
        const raceTrack = document.getElementById('raceTrack');
        if (raceTrack) raceTrack.style.display = 'block';
        updateRabbitPosition();
      }
    }
    
    function generateSerie(){
      let tables = GAME.tables;
      let serie = [];
      for(let i=0;i<GAME.nbQuestions;i++) {
        let a = tables[Math.floor(Math.random()*tables.length)];
        let b = Math.floor(Math.random()*12)+1;
        serie.push({a,b,r:a*b});
      }
      return serie;
    }
    
    startGame.onclick = () => {
      GAME = {
        tables: getTables(), 
        nbQuestions: parseInt(questionCount.value), 
        timeLimit: parseFloat(timeLimit.value)*60,
        noTimerMode: noTimerMode.checked,
        idx:0, 
        score:0, 
        timer:null, 
        timeLeft:0, 
        serie:[], 
        userAnswers:[]
      };
      
      if (GAME.tables.length===0) {
        alert('S√©lectionnez au moins une table'); 
        return;
      }
      
      GAME.serie = generateSerie();
      GAME.timeLeft = GAME.noTimerMode?0:GAME.timeLimit;
      GAME.userAnswers = [];
      
      showGame();
      showQuestion();
      
      if (!GAME.noTimerMode) {
        GAME.timer = setInterval(()=>{
          GAME.timeLeft--;
          updateTimerDisplay();
          if (GAME.timeLeft<=0) endGame();
        }, 1000);
      }
      
      updateTimerDisplay();
      updateProgressBar();
      savePrefs();
      
      // Son de d√©but de jeu
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      playSuccessSound(profile);
    };
    
    function showGame(){
      document.querySelector('.settings-panel').style.display='none';
      document.querySelector('.welcome-message').style.display='none';
      document.querySelector('.learn-panel').style.display='none';
      document.getElementById('gameArea').style.display='block';
      document.getElementById('resultsArea').style.display='none';
      document.getElementById('homePage').style.display='none';
      document.getElementById('learnPage').style.display='none';
      document.getElementById('tableDetailPage').style.display='none';
    }
    
    function showResults(){
      document.querySelector('.settings-panel').style.display='none';
      document.querySelector('.welcome-message').style.display='none';
      document.querySelector('.learn-panel').style.display='none';
      document.getElementById('gameArea').style.display='none';
      document.getElementById('resultsArea').style.display='block';
      document.getElementById('homePage').style.display='none';
      document.getElementById('learnPage').style.display='none';
      document.getElementById('tableDetailPage').style.display='none';
    }
    
    function showSettings(){
      document.querySelector('.settings-panel').style.display='block';
      document.querySelector('.welcome-message').style.display='block';
      document.querySelector('.learn-panel').style.display='block';
      document.getElementById('gameArea').style.display='none';
      document.getElementById('resultsArea').style.display='none';
      document.getElementById('homePage').style.display='block';
      document.getElementById('learnPage').style.display='none';
      document.getElementById('tableDetailPage').style.display='none';
    }
    
    const questionDiv=document.getElementById('question');
    const answerInput=document.getElementById('answerInput');
    const validateBtn=document.getElementById('validateBtn');
    
    function showQuestion(){
      let q=GAME.serie[GAME.idx];
      questionDiv.textContent = `${q.a} √ó ${q.b} = ?`;
      answerInput.value = '';
      answerInput.focus();
      updateProgressBar();
      updateTimerDisplay();
    }
    
    function doValidate(){
      let ans = parseInt(answerInput.value); 
      if (isNaN(ans)) ans = null;
      GAME.userAnswers.push(ans);
      
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      
      if (ans === GAME.serie[GAME.idx].r) {
        GAME.score++;
        playSuccessSound(profile);
      } else {
        playErrorSound(profile);
      }
      
      GAME.idx++;
      if (GAME.idx>=GAME.nbQuestions) endGame();
      else showQuestion();
    }
    
    validateBtn.onclick = doValidate;
    
    answerInput.addEventListener('keypress', e=>{
      if (e.key==="Enter") doValidate();
    });

    // ========== FIN DE PARTIE AVEC MESSAGES AL√âATOIRES ==========
    const medalElem = document.getElementById('medal');
    const medalText = document.getElementById('medalText');
    const medalMessage = document.getElementById('medalMessage');
    const finalScore = document.getElementById('finalScore');
    const correctCount = document.getElementById('correctCount');
    const incorrectCount = document.getElementById('incorrectCount');
    const missedCount = document.getElementById('missedCount');
    const successPercentage = document.getElementById('successPercentage');
    
    function endGame(){
      if (GAME.timer) clearInterval(GAME.timer);
      showResults();
      
      let answered = GAME.userAnswers.length;
      let nbQuestions = GAME.nbQuestions;
      let good = 0, bad = 0, miss=0;
      
      for(let i=0;i<nbQuestions;i++){
        if (typeof GAME.userAnswers[i]==="number") {
          if (GAME.userAnswers[i]===GAME.serie[i].r) good++;
          else bad++;
        } else miss++;
      }
      
      finalScore.textContent = `${good}/${nbQuestions}`;
      correctCount.textContent = good;
      incorrectCount.textContent = bad;
      missedCount.textContent = miss;
      let pct = nbQuestions===0 ? 0 : Math.round(100*good/nbQuestions);
      successPercentage.textContent = `${pct}%`;
      
      // D√©terminer m√©daille et message al√©atoire
      let medal = "üèÜ", medalName = "OR", medalType = "gold";
      
      if (nbQuestions == 10) {
        if(pct>=90){medal="üèÜ";medalName="OR";medalType="gold";}
        else if(pct>=80){medal="ü•à";medalName="ARGENT";medalType="silver";}
        else if(pct>=70){medal="ü•â";medalName="BRONZE";medalType="bronze";}
        else{medal=medalBlanche();medalName="PAPIER";medalType="paper";}
      } else {
        if(pct>=98){medal="üèÜ";medalName="OR";medalType="gold";}
        else if(pct>=95){medal="ü•à";medalName="ARGENT";medalType="silver";}
        else if(pct>=90){medal="ü•â";medalName="BRONZE";medalType="bronze";}
        else{medal=medalBlanche();medalName="PAPIER";medalType="paper";}
      }
      
      medalElem.innerHTML = medal;
      medalText.innerHTML = medalName;
      
      // Afficher message al√©atoire avec style appropri√©
      medalMessage.textContent = getRandomMedalMessage(medalType);
      medalMessage.className = `medal-message ${medalType}`;
      
      document.getElementById('resultsGrid').innerHTML = buildResultsGrid(GAME.serie, GAME.userAnswers);
      document.getElementById('errorsList').innerHTML = buildErrorsList(GAME.serie, GAME.userAnswers);
      
      // Son de fin selon r√©sultat
      const profile = document.body.getAttribute('data-profile') || 'CM2';
      if (medalType === 'gold') {
        playSuccessSound(profile);
      }
      
      // Sauvegarder les r√©sultats pour les statistiques
      const gameResults = {
        score: good,
        total: nbQuestions,
        questions: GAME.serie,
        answers: GAME.userAnswers,
        date: new Date().toISOString(),
        duration: GAME.noTimerMode ? 0 : (GAME.timeLimit - GAME.timeLeft)
      };
      
      // Mettre √† jour les statistiques avanc√©es (mode Adulte)
      if (document.body.getAttribute('data-profile') === 'ADULTE') {
        updateStatsCharts(gameResults);
        
        // Ajouter aux donn√©es de session
        statsData.sessions.push({
          date: new Date().toLocaleDateString(),
          score: pct,
          correct: good,
          incorrect: bad,
          duration: gameResults.duration
        });
        
        saveStatsData();
      }
    }
    
    function medalBlanche(){
      return `<svg width="64" height="64"><circle cx="32" cy="32" r="30" fill="#fff" stroke="#ccc" stroke-width="4"/><text x="32" y="44" text-anchor="middle" font-size="40" fill="#333" font-family="Arial" font-weight="bold">4</text></svg>`;
    }
    
    function buildResultsGrid(serie, userAnswers){
      let html = '<tr><th>√ó</th>';
      for(let i=1;i<=12;i++) html+=`<th>${i}</th>`;
      html+='</tr>';
      for(let a=1;a<=12;a++){
        html+=`<tr><th>${a}</th>`;
        for(let b=1;b<=12;b++){
          let klass = '';
          for(let i=0;i<serie.length;i++){
            if(serie[i].a===a && serie[i].b===b){
              if(userAnswers[i]===serie[i].r) klass='cell-correct';
              else if(userAnswers[i]==null) klass='cell-missed';
              else klass='cell-incorrect';
              break;
            }
          }
          html += `<td class="${klass}">${a*b}</td>`;
        }
        html+='</tr>';
      }
      return html;
    }
    
    function buildErrorsList(serie, userAnswers){
      let html = '';
      for(let i=0;i<serie.length;i++){
        if (typeof userAnswers[i]==="number" && userAnswers[i]!==serie[i].r){
          html += `<div>${serie[i].a}√ó${serie[i].b} = ${serie[i].r} <span style="color:#f44"> (r√©ponse : ${userAnswers[i]})</span></div>`;
        } else if (userAnswers[i]==null){
          html += `<div>${serie[i].a}√ó${serie[i].b} = ${serie[i].r} <span style="color:#ff0;"> (Non r√©pondu)</span></div>`;
        }
      }
      if (!html) html = "<div>Aucune erreur üëç</div>";
      return html;
    }
    
    document.getElementById('newGameBtn').onclick = () => startGame.onclick();
    document.getElementById('backToSettingsBtn').onclick = () => showSettings();

    // ========== INITIALISATION AU CHARGEMENT ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Initialiser le syst√®me audio
      initAudioSystem();
      
      // Charger les param√®tres sauvegard√©s au d√©marrage
      const savedProfile = localStorage.getItem(LS_PROFILE) || 'CM2';
      applyProfileSettings(savedProfile);
      
      // Afficher la page d'accueil
      showSettings();
      
      console.log('üöÄ Application TablesMathAssist initialis√©e avec le profil:', savedProfile);
    });
    
    // Application imm√©diate du profil par d√©faut
    const initialProfile = localStorage.getItem(LS_PROFILE) || 'CM2';
    applyProfileSettings(initialProfile);

    // Initialiser le syst√®me audio avec interaction utilisateur
    document.addEventListener('click', () => {
      if (!audioContext) {
        initAudioSystem();
      }
    }, { once: true });
  </script>
</body>
</html>
